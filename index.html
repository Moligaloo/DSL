<!DOCTYPE html>
<html>
<head>
	<title> DSL </title>
	<meta charset='utf8' />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="http://cdn.bootcss.com/jquery-mobile/1.4.5/jquery.mobile.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
	<script src="http://cdn.bootcss.com/jquery-mobile/1.4.5/jquery.mobile.min.js"></script>
	<script src="http://cdn.bootcss.com/pegjs/0.7.0/peg.min.js"></script>
</head>
<body>

<style type="text/css">
	
	/*
	used to highlight JSON output
	*/
	pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
	.string { color: green; }
	.number { color: darkorange; font-weight: bold; }
	.boolean { color: blue; }
	.null { color: magenta; }
	.key { color: red; }

	table{
		border-style: solid;
		border-width: 1px;
	}

	.omit{
		color: gray;
		font-style: italic;
	}

	#bad-text, #fail-skill-name{
		color: red;
		font-weight: bold;
	}

</style>

<script type="text/javascript">

	var parser = null;
	var skills = null;
	var result = null;

	$.get('rule.txt', function(data){
		parser = PEG.buildParser(data);
	});

	$.get('skills.json', function(data){
		skills = data;

		var default_index = skills.length-1;

		var skillList = $('#skillList');

		for (var i = 0; i < skills.length; i++) {
			var skill = skills[i];

			skillList.append(			
				$('<li>').append(
					$('<a>').text(skill.name)
					.attr('skillIndex', i)
					.attr('data-role', 'button')
					.attr('data-rel', 'back')
					.addClass('ui-btn')
					.click(function(event){
						var index = $(event.target).attr('skillIndex');
						setSkillWithIndex(index);
					})
				)
			);

			if("default" in skill)
				default_index = i;
		};

		setSkillWithIndex(default_index);
	});

	function createTable(obj){
		if(obj == null || obj == undefined)
			return null;

		if(typeof obj == 'string'){
			if(obj == ''){
				return $('<td>').text('省略').addClass('omit');
			}else{
				return $('<td>').text(obj);
			}
		}

		if(typeof obj == 'number')
			return $('<td>').text(obj).addClass('number');

		if(obj instanceof Array){
			if(obj.length == 0){
				return $('<td>').text('无').addClass('omit');
			}

			var table = $('<table>');
			for(var i=0; i<obj.length; i++){
				var e = obj[i];

				var row = createTable(e);
				if(row){
					table.append(row);
				}
			}

			return table;
		}

		if(obj instanceof Object){
			var table = $('<table>');
			for(var name in obj){
				var type_cell = $('<th>').text(name);
				var value_cell = $('<td>').append(createTable(obj[name]));

				var row = $('<tr>').append(type_cell).append(value_cell);
				table.append(row);
			}

			return table;
		}
	}

	function unescape_unicode_text(x){
		var r = /\\u([\d\w]{4})/gi;
		x = x.replace(r, function (match, grp) {
		    return String.fromCharCode(parseInt(grp, 16)); } );
		x = unescape(x);

		return x;
	}

	function regressionTest(){
		var skillName = null;
		var skillIndex = null;
		try{
			for (var i = 0; i < skills.length; i++) {
				skillIndex = i;

				var skill = skills[i]
				skillName = skill.name;
				parser.parse(skill.content);
			};

			skillName = null;
		}catch(e){
			$('#regression-good').hide();
			$('#regression-bad').show();
			$('#fail-skill-name').text(skillName);

			setSkillWithIndex(skillIndex);
			startParse();
		}

		if(skillName == null){
			$('#regression-good').show();
			$('#regression-bad').hide();
		}

		$('#regression-output').show();
		$('#regression-output').fadeOut(1000);
	}

	function startParse(){
		var text = $('#input').val();
		try{
			result = parser.parse(text);
			showTable();

			$('#error-output').hide();
		}catch(e){
			if('expected' in e){
				$('#good-text').text(text.substring(0, e.offset));
				$('#bad-text').text(text.substring(e.offset, e.offset+1));
				$('#unparsed-text').text(text.substring(e.offset+1));

				var expected = $('#expected');
				expected.empty();
				for (var i = 0; i < e.expected.length; i++) {
					expected.append($('<li>').text(unescape_unicode_text(e.expected[i]))); 
				};
			}else{
				$('#bad-text').text(e.toString());
			}

			$('#error-output').show();
			$('#output').empty();
		}
	}

	function setSkillWithIndex(i){
		$('#skillName').text(skills[i].name);
		$('#input').text(skills[i].content);
	}

	// code copied from http://stackoverflow.com/questions/4810841/how-can-i-pretty-print-json-using-javascript
	function syntaxHighlight(json) {
	    if (typeof json != 'string') {
	         json = JSON.stringify(json, undefined, 2);
	    }
	    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
	    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
	        var cls = 'number';
	        if (/^"/.test(match)) {
	            if (/:$/.test(match)) {
	                cls = 'key';
	            } else {
	                cls = 'string';
	            }
	        } else if (/true|false/.test(match)) {
	            cls = 'boolean';
	        } else if (/null/.test(match)) {
	            cls = 'null';
	        }
	        return '<span class="' + cls + '">' + match + '</span>';
	    });
	}

	function showJSON(){
		$('#output').empty().append($('<pre>').html(syntaxHighlight(result)));

		$('#showJSONLink').hide();
		$('#showTableLink').show();
	}

	function showTable(){
		$('#output').empty().append(createTable(result));

		$('#showJSONLink').show();
		$('#showTableLink').hide();
	}

</script>


<div data-role="page">

	<div data-role="header">
		<h1> 太阳神三国杀 DSL 在线解析器</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<div>
		    <label for="skills">已有技能:</label>

			<a href="#skillMenu" 
				data-rel="popup" data-transition="slideup" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-gear ui-btn-icon-left ui-btn-a"> <span id='skillName'> 选择技能 </span></a>

			<div data-role="popup" id="skillMenu">
				<ul data-role="listview" id='skillList' data-inset="true" style="min-width:210px;">
			    </ul>
			</div>
		</div>

		<label for="input"> DSL :</label>
		<textarea cols="40" rows="8" name="input" id="input"></textarea>
		<button onclick="startParse()" class='ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-arrow-r ui-btn-icon-left ui-btn-a'> 开始解析 </button>
		
		<button onclick="regressionTest()" class='ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a'> 回归测试 </button>
		<div id='regression-output' style="display:none">
			<div id='regression-good'> 回归测试成功 </div>
			<div id='regression-bad'> 回归测试失败，失败的技能是 <span id='fail-skill-name'></span> </div>
		</div>

		<div id='error-output' style='display:none'>
			<p>解析出错:  <p>
			期待的文本:
				<ol id='expected'>
				</ol>
			<p>
				<span id="good-text"> </span>
				<span id='bad-text'> </span>
				<span id='unparsed-text'> </span>
			</p> 
		</div>
		
		<label for='output'> 输出 (
			<a id='showJSONLink' onclick="showJSON()">JSON </a> 
			<a id='showTableLink' onclick="showTable()" style='display:none'> 表格</a>
		): </label>
		<div id='output' class='ui-content'>
		</div>

	</div>

	<div data-role="footer">
		<h4> Created by <a href='http://weibo.com/moligaloo'>  Moligaloo <img src='http://tp1.sinaimg.cn/2010950772/180/40020141640/1' width='50'/> </a> </h4>
		<h4> Powered by <a href='https://jquerymobile.com/'>jQuery Mobile</a> &amp; <a href='http://pegjs.org/'>pegjs</a></h4>
	</div>

</div>


</body>
</html>