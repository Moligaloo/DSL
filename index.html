<!DOCTYPE html>
<html>
<head>
	<title> DSL </title>
	<meta charset='utf8' />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="http://cdn.bootcss.com/jquery-mobile/1.4.5/jquery.mobile.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
	<script src="http://cdn.bootcss.com/jquery-mobile/1.4.5/jquery.mobile.min.js"></script>
	<script src="http://cdn.bootcss.com/pegjs/0.7.0/peg.min.js"></script>
</head>
<body>

<style type="text/css">
	
	/*
	used to highlight JSON output
	*/
	pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
	.string { color: green; }
	.number { color: darkorange; }
	.boolean { color: blue; }
	.null { color: magenta; }
	.key { color: red; }

	table{
		border-style: solid;
		border-width: 1px;
	}

	.omit{
		color: gray;
	}

</style>

<script type="text/javascript">

	var parser = null;
	var skills = null;
	var result = null;

	$.get('rule.txt', function(data){
		parser = PEG.buildParser(data);
	});

	$.get('skills.json', function(data){
		skills = data;

		var default_index = skills.length-1;

		var skillList = $('#skillList');

		for (var i = 0; i < skills.length; i++) {
			var skill = skills[i];

			skillList.append(			
				$('<li>').append(
					$('<a>').text(skill.name)
					.attr('skillIndex', i)
					.attr('data-role', 'button')
					.attr('data-rel', 'back')
					.addClass('ui-btn')
					.click(function(event){
						var index = $(event.target).attr('skillIndex');
						setSkillWithIndex(index);
					})
				)
			);

			if("default" in skill)
				default_index = i;
		};

		setSkillWithIndex(default_index);
	});

	function createTable(obj){
		if(obj == null || obj == undefined)
			return null;

		if(typeof obj == 'string'){
			if(obj == ''){
				return $('<td>').append($('<i>').text('省略').addClass('omit'));
			}else{
				return $('<td>').text(obj);
			}
		}

		if(typeof obj == 'number')
			return $('<td>').append($('<b>').text(obj).addClass('number'));

		if(obj instanceof Array){
			var table = $('<table>');
			for(var i=0; i<obj.length; i++){
				var e = obj[i];

				var row = createTable(e);
				if(row){
					table.append(row);
				}
			}

			return table;
		}

		if(obj instanceof Object){
			var table = $('<table>');
			for(var name in obj){
				var type_cell = $('<th>').text(name);
				var value_cell = $('<td>').append(createTable(obj[name]));

				var row = $('<tr>').append(type_cell).append(value_cell);
				table.append(row);
			}

			return table;
		}
	}

	function startParse(){
		var text = $('#input').val();
		try{
			result = parser.parse(text);
			showTable();
		}catch(e){
			var x = e.toString();
			var r = /\\u([\d\w]{4})/gi;
			x = x.replace(r, function (match, grp) {
			    return String.fromCharCode(parseInt(grp, 16)); } );
			x = unescape(x);
			alert("解析出错！" + x);
		}
	}

	function setSkillWithIndex(i){
		$('#skillName').text(skills[i].name);
		$('#input').text(skills[i].content);
	}

	// code copied from http://stackoverflow.com/questions/4810841/how-can-i-pretty-print-json-using-javascript
	function syntaxHighlight(json) {
	    if (typeof json != 'string') {
	         json = JSON.stringify(json, undefined, 2);
	    }
	    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
	    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
	        var cls = 'number';
	        if (/^"/.test(match)) {
	            if (/:$/.test(match)) {
	                cls = 'key';
	            } else {
	                cls = 'string';
	            }
	        } else if (/true|false/.test(match)) {
	            cls = 'boolean';
	        } else if (/null/.test(match)) {
	            cls = 'null';
	        }
	        return '<span class="' + cls + '">' + match + '</span>';
	    });
	}

	function showJSON(){
		$('#output').empty().append($('<pre>').html(syntaxHighlight(result)));

		$('#showJSONLink').hide();
		$('#showTableLink').show();
	}

	function showTable(){
		$('#output').empty().append(createTable(result));

		$('#showJSONLink').show();
		$('#showTableLink').hide();
	}

</script>


<div data-role="page">

	<div data-role="header">
		<h1> 太阳神三国杀 DSL 在线解析器</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<div>
		    <label for="skills">已有技能:</label>

			<a href="#skillMenu" 
				data-rel="popup" data-transition="slideup" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-gear ui-btn-icon-left ui-btn-a"> <span id='skillName'> 选择技能 </span></a>

			<div data-role="popup" id="skillMenu">
				<ul data-role="listview" id='skillList' data-inset="true" style="min-width:210px;">
			    </ul>
			</div>
		</div>

		<label for="input"> DSL :</label>
		<textarea cols="40" rows="8" name="input" id="input"></textarea>
		<button onclick="startParse()" > 开始解析 </button>
		<label for='output'> 输出 (
			<a id='showJSONLink' onclick="showJSON()">JSON </a> 
			<a id='showTableLink' onclick="showTable()" style='display:none'> 表格</a>
		): </label>
		<div id='output' class='ui-content'>
		</div>

	</div>

	<div data-role="footer">
		<h4> Powered by <a href='https://jquerymobile.com/'>jQuery Mobile</a> &amp; <a href='http://pegjs.org/'>pegjs</a></h4>
	</div>

</div>


</body>
</html>